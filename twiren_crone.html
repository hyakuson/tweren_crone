<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>ツイ連エディタの独自クローン</title>
</head>

<body>
    <h1>ツイ連エディタの独自クローン</h1>
    <div class="main_area">
        <div id="editor_area" class="box"></div>
        <div id="flat_text_area" class="box flat_text_area"></div>
    </div>
    <button id="add_textarea_button">増やす</button>

    <hr>
    <div id="embeded_html"></div>

    <script src='https://cdn.mlkcca.com/v2.0.0/milkcocoa.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="documentList.js"></script>
    <script>documentList.start("twiren_copy");</script>
    <script src="accesscounter.js"></script>
    <script>accesscounter.start("twiren_crone","twiren_crone");</script>
    <script>
        $(window).load(function () {

            // 最初は2つ表示する
            appendTextareaLast();
            appendParagraghLast();
            appendTextareaLast();
            appendParagraghLast();

            $('#add_textarea_button').click(function () {
                appendTextareaLast();
                appendParagraghLast();
            });

            // キー入力時文字数をカウントする
            $('#editor_area').on('keyup', '.textarea', function (e) {
                countCharacters(e.target);

                //右ペインと同期
                var index = $('div[name=twirens]').index($(e.target).parent());
                //整形(改行を再現)
                var formedText = formatText($(e.target).val());
                //$('#flat_text_area').children().eq(index).text($(e.target).val());
                $('#flat_text_area').children().eq(index).html(formedText);
            });
            
            // 入力文字列を整形する
            function formatText(str) {
                var ret = str.replace(/\n/g, '<br>');
                return ret;
            };

            // Shift+Enterでカーソル位置より後ろのテキストを新しくつくるテキストエリアに入れる
            $('#editor_area').on('keydown', '.textarea', function (e) {
                if (event.shiftKey) {
                    if (e.keyCode === 13) {

                        /* editor_areaに新しいdivを追加 */
                        var div = $('<div>')
                            .attr('name', 'twirens');
                        var textarea = $('<textarea>')
                            .attr('name', 'textarea')
                            .attr('class', 'textarea')
                            .attr('placeholder', "140文字以内で入力。Ctrl+Enterでテキストエリアを増やす。")
                            .appendTo(div);
                        var sapn = $('<span>')
                            .attr('class', 'char_count')
                            .text('140')
                            .appendTo(div);
                        $(e.target).parent().after(div);
                        //フォーカスを新しいテキストエリアに移す
                        textarea.focus();

                        /*flat_text_areaにparagraghを追加*/
                        // 現在のテキストエリアの要素数を取得する
                        var index = $('div[name=twirens]').index($(e.target).parent());
                        var paragragh = document.createElement('p');
                        paragragh.setAttribute('class', 'paragragh');
                        $('#flat_text_area').children().eq(index).after(paragragh);

                        return false; //Enterが実行されないようにfalseを返す
                    }
                }
            });

            function appendTextareaLast() {
                var div = $('<div>')
                    .attr('name', 'twirens');
                var textarea = $('<textarea>')
                    .attr('name', 'textarea')
                    .attr('class', 'textarea')
                    .attr('placeholder', "140文字以内で入力。Ctrl+Enterでテキストエリアを増やす。")
                    .appendTo(div);
                var sapn = $('<span>')
                    .attr('class', 'char_count')
                    .text('140')
                    .appendTo(div);
                $('#editor_area').append(div);
            }

            function appendParagraghLast() {
                $('<p>')
                    .text("　")
                    .attr('class', 'paragragh')
                    .appendTo($('#flat_text_area'));
            }

            // テキストエリアの文字数のカウント
            function countCharacters(textarea) {
                $(textarea).next('span').text(140 - textarea.value.length);
            }
        });
    </script>
</body>

</html>